<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MigrationManager - Technical Reference</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../book.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Technical Reference</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/agglayer/vault-bridge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="migrationmanager"><a class="header" href="#migrationmanager">MigrationManager</a></h1>
<p><a href="https://github.com/agglayer/vault-bridge/blob/2c76a3249f25aa635aad39bd435c00f1c4cfe601/src/MigrationManager.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
<a href="/src/etc/IBridgeMessageReceiver.sol/interface.IBridgeMessageReceiver.html">IBridgeMessageReceiver</a>, Initializable, AccessControlUpgradeable, PausableUpgradeable, ReentrancyGuardTransientUpgradeable, <a href="/src/etc/Versioned.sol/abstract.Versioned.html">Versioned</a></p>
<p><strong>Author:</strong>
See https://github.com/agglayer/vault-bridge</p>
<p>Migration Manager is a singleton contract on Layer X.</p>
<p>Backing for Custom Tokens minted by Native Converters on Layer Ys can be migrated to Migration Manager on Layer X. Migration Manager completes migrations by calling <code>completeMigration</code> on the corresponidng vbToken, which mints vbToken and bridges it to address zero on the Layer Ys, effectively locking the backing in LxLy Bridge. Please refer to <code>onMessageReceived</code> for more information.</p>
<p><em>Main functionality.</em></p>
<p><em>Other functionality.</em></p>
<p><em>Libraries.</em></p>
<p><em>External contracts.</em></p>
<p><em>This contract exists to prevent manipulation of vbTokens' internal accounting through reentrancy (specifically, claiming assets on LxLy Bridge to vbToken mid-execution).</em></p>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="_migration_manager_storage"><a class="header" href="#_migration_manager_storage">_MIGRATION_MANAGER_STORAGE</a></h3>
<p><em>The storage slot at which Migration Manager storage starts, following the EIP-7201 standard.</em></p>
<p><em>Calculated as <code>keccak256(abi.encode(uint256(keccak256("agglayer.vault-bridge.MigrationManager.storage")) - 1)) &amp; ~bytes32(uint256(0xff))</code>.</em></p>
<pre><code class="language-solidity">bytes32 private constant _MIGRATION_MANAGER_STORAGE =
    hex"30cf29e424d82bdf294fbec113ef39ac73137edfdb802b37ef3fc9ad433c5000";
</code></pre>
<h3 id="pauser_role"><a class="header" href="#pauser_role">PAUSER_ROLE</a></h3>
<pre><code class="language-solidity">bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="onlylxlybridge"><a class="header" href="#onlylxlybridge">onlyLxLyBridge</a></h3>
<p><em>Checks if the sender is LxLy Bridge.</em></p>
<pre><code class="language-solidity">modifier onlyLxLyBridge();
</code></pre>
<h3 id="receive"><a class="header" href="#receive">receive</a></h3>
<pre><code class="language-solidity">receive() external payable;
</code></pre>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<pre><code class="language-solidity">constructor();
</code></pre>
<h3 id="initialize"><a class="header" href="#initialize">initialize</a></h3>
<p>Initializes the Migration Manager contract.</p>
<pre><code class="language-solidity">function initialize(address owner_, address lxlyBridge_, address wrappedGasToken_) external initializer;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>owner_</code></td><td><code>address</code></td><td>(ATTENTION) This address will be granted the <code>DEFAULT_ADMIN_ROLE</code>, as well as all basic roles. Roles can be modified at any time.</td></tr>
<tr><td><code>lxlyBridge_</code></td><td><code>address</code></td><td></td></tr>
<tr><td><code>wrappedGasToken_</code></td><td><code>address</code></td><td>The address of the wrapped gas token (e.g., WETH, if the gas token is ETH). Must be the same as the underlying token of the corresponding vbToken (e.g., vbETH, if the gas token is ETH).</td></tr>
</tbody></table>
</div>
<h3 id="lxlybridge"><a class="header" href="#lxlybridge">lxlyBridge</a></h3>
<p>LxLy Bridge, which connects AggLayer networks.</p>
<pre><code class="language-solidity">function lxlyBridge() public view returns (ILxLyBridge);
</code></pre>
<h3 id="nativeconvertersconfiguration"><a class="header" href="#nativeconvertersconfiguration">nativeConvertersConfiguration</a></h3>
<p>Tells which vbToken Native Converter on Layer a Y belongs to.</p>
<pre><code class="language-solidity">function nativeConvertersConfiguration(uint32 layerYLxlyId, address nativeConverter)
    public
    view
    returns (TokenPair memory tokenPair);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>layerYLxlyId</code></td><td><code>uint32</code></td><td>Layer Y's LxLy ID.</td></tr>
<tr><td><code>nativeConverter</code></td><td><code>address</code></td><td>The address of Native Converter on Layer Y.</td></tr>
</tbody></table>
</div>
<h3 id="_getmigrationmanagerstorage"><a class="header" href="#_getmigrationmanagerstorage">_getMigrationManagerStorage</a></h3>
<p><em>Returns a pointer to the ERC-7201 storage namespace.</em></p>
<pre><code class="language-solidity">function _getMigrationManagerStorage() private pure returns (MigrationManagerStorage storage $);
</code></pre>
<h3 id="configurenativeconverters"><a class="header" href="#configurenativeconverters">configureNativeConverters</a></h3>
<p>Maps Native Converters on Layer Ys to vbToken and underlying token on Layer X.</p>
<p>This function can be called by the owner only.</p>
<p><em>CAUTION! Misconfiguration could allow an attacker to gain unauthorized access to vbToken and other contracts.</em></p>
<pre><code class="language-solidity">function configureNativeConverters(
    uint32[] calldata layerYLxlyIds,
    address[] calldata nativeConverters,
    address payable vbToken
) external onlyRole(DEFAULT_ADMIN_ROLE) nonReentrant;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>layerYLxlyIds</code></td><td><code>uint32[]</code></td><td>The Layer Ys' LxLy IDs.</td></tr>
<tr><td><code>nativeConverters</code></td><td><code>address[]</code></td><td>The addresses of Native Converters on Layer Ys.</td></tr>
<tr><td><code>vbToken</code></td><td><code>address payable</code></td><td>The address of vbToken on Layer X Native Converter belongs to. Set to address zero to unset the tokens. You can override tokens without unsetting them first.</td></tr>
</tbody></table>
</div>
<h3 id="onmessagereceived"><a class="header" href="#onmessagereceived">onMessageReceived</a></h3>
<p><em>When Native Converter migrates backing, it calls both <code>bridgeAsset</code> and <code>bridgeMessage</code> on LxLy Bridge to <code>migrateBackingToLayerX</code>.</em></p>
<p><em>The asset must be claimed before the message on LxLy Bridge.</em></p>
<p><em>The message tells vbToken how much Custom Token must be backed by vbToken, which is minted and bridged to address zero on the respective Layer Y. This action provides liquidity when bridging Custom Token to from Layer Ys to Layer X and increments the pessimistic proof.</em></p>
<p><em>This function can be called by LxLy Bridge only.</em></p>
<pre><code class="language-solidity">function onMessageReceived(address originAddress, uint32 originNetwork, bytes memory data)
    external
    payable
    whenNotPaused
    onlyLxLyBridge
    nonReentrant;
</code></pre>
<h3 id="pause"><a class="header" href="#pause">pause</a></h3>
<p>Prevents usage of functions with the <code>whenNotPaused</code> modifier.</p>
<p>This function can be called by the owner only.</p>
<pre><code class="language-solidity">function pause() external onlyRole(PAUSER_ROLE) nonReentrant;
</code></pre>
<h3 id="unpause"><a class="header" href="#unpause">unpause</a></h3>
<p>Allows usage of functions with the <code>whenNotPaused</code> modifier.</p>
<p>This function can be called by the owner only.</p>
<pre><code class="language-solidity">function unpause() external onlyRole(DEFAULT_ADMIN_ROLE) nonReentrant;
</code></pre>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="nativeconverterconfigured"><a class="header" href="#nativeconverterconfigured">NativeConverterConfigured</a></h3>
<pre><code class="language-solidity">event NativeConverterConfigured(uint32 indexed layerYLxlyId, address indexed nativeConverter, address indexed vbToken);
</code></pre>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<h3 id="invalidowner"><a class="header" href="#invalidowner">InvalidOwner</a></h3>
<pre><code class="language-solidity">error InvalidOwner();
</code></pre>
<h3 id="invalidlxlybridge"><a class="header" href="#invalidlxlybridge">InvalidLxLyBridge</a></h3>
<pre><code class="language-solidity">error InvalidLxLyBridge();
</code></pre>
<h3 id="invalidwrappedgastoken"><a class="header" href="#invalidwrappedgastoken">InvalidWrappedGasToken</a></h3>
<pre><code class="language-solidity">error InvalidWrappedGasToken();
</code></pre>
<h3 id="nonmatchinginputlengths"><a class="header" href="#nonmatchinginputlengths">NonMatchingInputLengths</a></h3>
<pre><code class="language-solidity">error NonMatchingInputLengths();
</code></pre>
<h3 id="invalidlayerylxlyid"><a class="header" href="#invalidlayerylxlyid">InvalidLayerYLxLyId</a></h3>
<pre><code class="language-solidity">error InvalidLayerYLxLyId();
</code></pre>
<h3 id="invalidnativeconverter"><a class="header" href="#invalidnativeconverter">InvalidNativeConverter</a></h3>
<pre><code class="language-solidity">error InvalidNativeConverter();
</code></pre>
<h3 id="invalidunderlyingtoken"><a class="header" href="#invalidunderlyingtoken">InvalidUnderlyingToken</a></h3>
<pre><code class="language-solidity">error InvalidUnderlyingToken();
</code></pre>
<h3 id="unauthorized"><a class="header" href="#unauthorized">Unauthorized</a></h3>
<pre><code class="language-solidity">error Unauthorized();
</code></pre>
<h3 id="cannotwrapgastoken"><a class="header" href="#cannotwrapgastoken">CannotWrapGasToken</a></h3>
<pre><code class="language-solidity">error CannotWrapGasToken();
</code></pre>
<h3 id="insufficientunderlyingtokenbalanceafterwrapping"><a class="header" href="#insufficientunderlyingtokenbalanceafterwrapping">InsufficientUnderlyingTokenBalanceAfterWrapping</a></h3>
<pre><code class="language-solidity">error InsufficientUnderlyingTokenBalanceAfterWrapping(uint256 newBalance, uint256 expectedBalance);
</code></pre>
<h2 id="structs"><a class="header" href="#structs">Structs</a></h2>
<h3 id="tokenpair"><a class="header" href="#tokenpair">TokenPair</a></h3>
<p><em>Used for mapping Native Converters to vbTokens.</em></p>
<pre><code class="language-solidity">struct TokenPair {
    VaultBridgeToken vbToken;
    IERC20 underlyingToken;
}
</code></pre>
<h3 id="migrationmanagerstorage"><a class="header" href="#migrationmanagerstorage">MigrationManagerStorage</a></h3>
<p><em>Storage of the Migration Manager contract.</em></p>
<p><em>It's implemented on a custom ERC-7201 namespace to reduce the risk of storage collisions when using with upgradeable contracts.</em></p>
<p><strong>Note:</strong>
storage-location: erc7201:agglayer.vault-bridge.MigrationManager.storage</p>
<pre><code class="language-solidity">struct MigrationManagerStorage {
    ILxLyBridge lxlyBridge;
    uint32 _lxlyId;
    mapping(uint32 layerYLxLyId =&gt; mapping(address nativeConverter =&gt; TokenPair tokenPair))
        nativeConvertersConfiguration;
    IWETH9 _wrappedGasToken;
}
</code></pre>
<h2 id="enums"><a class="header" href="#enums">Enums</a></h2>
<h3 id="crossnetworkinstruction"><a class="header" href="#crossnetworkinstruction">CrossNetworkInstruction</a></h3>
<p><em>Used in cross-network communication.</em></p>
<pre><code class="language-solidity">enum CrossNetworkInstruction {
    _0_COMPLETE_MIGRATION,
    _1_WRAP_GAS_TOKEN_AND_COMPLETE_MIGRATION
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../src/CustomToken.sol/abstract.CustomToken.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../src/NativeConverter.sol/abstract.NativeConverter.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../src/CustomToken.sol/abstract.CustomToken.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../src/NativeConverter.sol/abstract.NativeConverter.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../solidity.min.js"></script>


    </div>
    </body>
</html>
